<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gamma Exposure Viewer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --bg: #0e1117;
    --panel: #161b22;
    --text: #e6edf3;
    --muted: #8b949e;
    --call: #2ecc71;
    --put: #e74c3c;
}
body {
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, Arial, sans-serif;
    margin: 40px;
}

h1 {
    margin-bottom: 5px;
}

p {
    color: var(--muted);
}

.container {
    max-width: 1100px;
}

input {
    margin-top: 15px;
}

.card {
    background: var(--panel);
    padding: 20px;
    border-radius: 10px;
    margin-top: 25px;
}

canvas {
    margin-top: 20px;
}
</style>
</head>

<body>
<div class="container">
    <h1>Multi-Ticker Gamma Exposure</h1>
    <p>Upload up to three Thinkorswim CSVs. Each chart updates independently.</p>

    <div class="grid">
        <div class="card">
            <h3>Ticker 1</h3>
            <input type="file" accept=".csv" onchange="handleFile(event, 0)">
            <canvas id="chart0"></canvas>
        </div>

        <div class="card">
            <h3>Ticker 2</h3>
            <input type="file" accept=".csv" onchange="handleFile(event, 1)">
            <canvas id="chart1"></canvas>
        </div>

        <div class="card">
            <h3>Ticker 3</h3>
            <input type="file" accept=".csv" onchange="handleFile(event, 2)">
            <canvas id="chart2"></canvas>
        </div>
    </div>
</div>
</body>

<script>
const charts = {};

function handleFile(event, chartIndex) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);

        // Spot price from Thinkorswim cell A5
        const spot = parseFloat(lines[4].split(",")[0]);
        if (isNaN(spot)) {
            alert("Spot price not found in cell A5");
            return;
        }

        // Remove Thinkorswim metadata rows
        const dataLines = lines.slice(11).join("\n");

        Papa.parse(dataLines, {
            header: true,
            skipEmptyLines: true,
            complete: res => buildChart(res.data, spot, chartIndex)
        });
    };
    reader.readAsText(file);
}

function buildChart(rows, spot, index) {
    const strikes = [];
    const callGEX = [];
    const putGEX = [];
console.table(rows.slice(0, 5));
    rows.forEach(r => {
        const strike = parseFloat(r["Strike"]);
        if (isNaN(strike)) return;

        // CALL SIDE (LEFT)
        const callGamma = parseFloat(r["Gamma"]) || 0;
        const callOI = parseFloat(r["Open.Int"]) || 0;

        // PUT SIDE (RIGHT)
        const putGamma = parseFloat(r["Gamma_1"]) || 0;
        const putOI = parseFloat(r["Open.Int_1"]) || 0;

        strikes.push(strike);
        callGEX.push(callGamma * callOI * 100 * spot);
        putGEX.push(putGamma * putOI * 100 * spot);
    });

    const ctx = document.getElementById(`chart${index}`).getContext("2d");
    if (charts[index]) charts[index].destroy();

    const spotLinePlugin = {
        id: "spotLine",
        afterDraw(chart) {
            const xScale = chart.scales.x;
            const yScale = chart.scales.y;
            const idx = strikes.findIndex(s => s >= spot);
            if (idx === -1) return;

            const x = xScale.getPixelForValue(idx);
            const c = chart.ctx;
            c.save();
            c.strokeStyle = "#ff4d9d"; // pink
            c.setLineDash([6,6]);
            c.lineWidth = 2;
            c.beginPath();
            c.moveTo(x, yScale.top);
            c.lineTo(x, yScale.bottom);
            c.stroke();
            c.restore();
        }
    };

    charts[index] = new Chart(ctx, {
        type: "line",
        plugins: [spotLinePlugin],
        data: {
            labels: strikes,
            datasets: [
                {
                    label: "Call GEX",
                    data: callGEX,
                    borderColor: "#2ecc71", // ✅ GREEN = CALLS
                    borderWidth: 2,
                    tension: 0.25
                },
                {
                    label: "Put GEX",
                    data: putGEX,
                    borderColor: "#e74c3c", // ✅ RED = PUTS
                    borderWidth: 2,
                    tension: 0.25
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: "#e6edf3" }
                }
            },
            scales: {
                x: {
                    ticks: { color: "#8b949e" },
                    title: { display: true, text: "Strike", color: "#8b949e" }
                },
                y: {
                    ticks: {
                        color: "#8b949e",
                        callback: v => v.toLocaleString()
                    },
                    title: {
                        display: true,
                        text: "Gamma Exposure",
                        color: "#8b949e"
                    }
                }
            }
        }
    });
}
</script>
