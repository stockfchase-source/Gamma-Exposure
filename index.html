<script>
const charts = [];

function toNumber(value) {
    if (value === null || value === undefined) return 0;
    if (typeof value === "number") return value;

    return Number(
        value.toString()
            .replace(/"/g, "")
            .replace(/,/g, "")
            .trim()
    ) || 0;
}

function loadCSV(event, chartIndex) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        const lines = e.target.result.split("\n");

        const spot = toNumber(lines[4]?.split(",")[0]);
        const header = lines[11];
        const body = lines.slice(12);
        const csvData = [header, ...body].join("\n");

        Papa.parse(csvData, {
            header: true,
            skipEmptyLines: true,
            complete: results => {
                buildChart(results.data, spot, chartIndex);
            }
        });
    };

    reader.readAsText(file);
}

function buildChart(rows, spot, index) {

    const callGEX = [];
    const putGEX  = [];

    rows.forEach(r => {
        const strike = toNumber(r["Strike"]);
        if (!strike) return;

        const callGamma = toNumber(r["Gamma"]);
        const callOI    = toNumber(r["Open.Int"]);
        const putGamma  = toNumber(r["Gamma_1"]);
        const putOI     = toNumber(r["Open.Int_1"]);

        callGEX.push({
            x: strike,
            y: callGamma * callOI * 100 * spot
        });

        putGEX.push({
            x: strike,
            y: putGamma * putOI * 100 * spot
        });
    });

    if (charts[index]) charts[index].destroy();

    charts[index] = new Chart(
        document.getElementById(`chart${index}`),
        {
            type: "line",
            data: {
                datasets: [
                    {
                        label: "Call GEX",
                        data: callGEX,
                        borderColor: "#2ecc71",
                        borderWidth: 2,
                        tension: 0.25
                    },
                    {
                        label: "Put GEX",
                        data: putGEX,
                        borderColor: "#e74c3c",
                        borderWidth: 2,
                        tension: 0.25
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: "#e6edf3" }
                    },
                    annotation: {
                        annotations: {
                            spotLine: {
                                type: "line",
                                scaleID: "x",
                                xMin: spot,
                                xMax: spot,
                                borderColor: "#ff4fd8",
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    enabled: true,
                                    content: `Spot ${spot}`,
                                    position: "start",
                                    color: "#ff4fd8"
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: "linear",
                        title: {
                            display: true,
                            text: "Strike",
                            color: "#e6edf3"
                        },
                        ticks: { color: "#e6edf3" }
                    },
                    y: {
                        title: {
                            display: true,
                            text: "Gamma Exposure",
                            color: "#e6edf3"
                        },
                        ticks: { color: "#e6edf3" }
                    }
                }
            }
        }
    );
}
</script>
