<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multi-Ticker Gamma Exposure</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
    background-color: #0e1117;
    color: #e6edf3;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
}

h2 {
    margin-bottom: 5px;
}

.chart-container {
    margin-bottom: 40px;
}

input[type="file"] {
    margin-bottom: 10px;
}

canvas {
    background: #0e1117;
    border-radius: 10px;
}
</style>
</head>

<body>

<h1>Gamma Exposure Dashboard</h1>

<div class="chart-container">
    <h2>Ticker 1</h2>
    <input type="file" onchange="loadCSV(event, 0)">
    <canvas id="chart0" height="300"></canvas>
</div>

<div class="chart-container">
    <h2>Ticker 2</h2>
    <input type="file" onchange="loadCSV(event, 1)">
    <canvas id="chart1" height="300"></canvas>
</div>

<div class="chart-container">
    <h2>Ticker 3</h2>
    <input type="file" onchange="loadCSV(event, 2)">
    <canvas id="chart2" height="300"></canvas>
</div>

<script>
const charts = [];

/* -------------------------------
   SAFE NUMBER PARSER
-------------------------------- */
function toNumber(value) {
    if (value === null || value === undefined) return 0;
    if (typeof value === "number") return value;

    const cleaned = value
        .toString()
        .replace(/"/g, "")
        .replace(/,/g, "")
        .trim();

    const num = Number(cleaned);
    return isNaN(num) ? 0 : num;
}

/* -------------------------------
   CSV LOADER
-------------------------------- */
function loadCSV(event, chartIndex) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        const lines = e.target.result.split("\n");

        // Spot price = cell A5 (row index 4)
        const spot = toNumber(lines[4]?.split(",")[0]);

        // Header row starts at row 12 (index 11)
        const header = lines[11];
        const body = lines.slice(12);
        const csvData = [header, ...body].join("\n");

        Papa.parse(csvData, {
            header: true,
            skipEmptyLines: true,
            complete: results => {
                buildChart(results.data, spot, chartIndex);
            }
        });
    };

    reader.readAsText(file);
}

/* -------------------------------
   CHART BUILDER
-------------------------------- */
function buildChart(rows, spot, index) {

    const strikes = [];
    const callGEX = [];
    const putGEX  = [];

    rows.forEach(r => {
        const strike = toNumber(r["Strike"]);
        if (!strike) return;

        const callGamma = toNumber(r["Gamma"]);
        const callOI    = toNumber(r["Open.Int"]);

        const putGamma  = toNumber(r["Gamma_1"]);
        const putOI     = toNumber(r["Open.Int_1"]);

        strikes.push(strike);
        callGEX.push(callGamma * callOI * 100 * spot);
        putGEX.push(putGamma * putOI * 100 * spot);
    });

    if (charts[index]) charts[index].destroy();

    charts[index] = new Chart(
        document.getElementById(`chart${index}`),
        {
            type: "line",
            data: {
                labels: strikes,
                datasets: [
                    {
                        label: "Call GEX",
                        data: callGEX,
                        borderColor: "#2ecc71", // GREEN
                        borderWidth: 2,
                        tension: 0.25
                    },
                    {
                        label: "Put GEX",
                        data: putGEX,
                        borderColor: "#e74c3c", // RED
                        borderWidth: 2,
                        tension: 0.25
                    }
                ]
            },
            options: {
                plugins: {
                    legend: {
                        labels: { color: "#e6edf3" }
                    },
                    annotation: {
                        annotations: {
                            spotLine: {
                                type: "line",
                                xMin: spot,
                                xMax: spot,
                                borderColor: "#ff4fd8", // PINK
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    enabled: true,
                                    content: "Spot",
                                    color: "#ff4fd8",
                                    position: "top"
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: "Strike",
                            color: "#e6edf3"
                        },
                        ticks: { color: "#e6edf3" }
                    },
                    y: {
                        title: {
                            display: true,
                            text: "Gamma Exposure",
                            color: "#e6edf3"
                        },
                        ticks: { color: "#e6edf3" }
                    }
                }
            }
        }
    );
}
</script>

</body>
</html>
